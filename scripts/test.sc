// REQUIRED SETUP
interp.repositories() ++= Seq(coursierapi.MavenRepository.of("http://maven.snplow.com/releases/"), coursierapi.MavenRepository.of("http://snowplow.bintray.com/snowplow-maven"))

@

import $url.{`https://raw.githubusercontent.com/snowplow-incubator/snowplow-event-recovery/master/scripts/Recovery.sc` => Recovery}, Recovery._
import $ivy.`com.snowplowanalytics::snowplow-event-recovery-core:0.3.1`, com.snowplowanalytics.snowplow.event.recovery._, config._, json._

// ACTUAL TESTS
// for available functions see [[https://raw.githubusercontent.com/snowplow-incubator/snowplow-event-recovery/feature/recovery-typeclasses/scripts/Recovery.sc]]

//operations.cast("""{"int": "1"}""", "$.int", CastType.String, CastType.Array)
//operations.replace("""{"int": "1"}""", "$.int", "(?U)^.*$", "new")

//val cfg = """{"schema": "iglu:com.snowplowanalytics.snowplow/recoveries/jsonschema/4-0-0", "data": { "iglu:com.snowplowanalytics.snowplow.badrows/schema_violations/jsonschema/2-0-0": [{"name": "Replace", "conditions":[],"steps":[{"op": "Replace", "path": "$.", "match": "\"agent\"", "value": "agents"}]}]}}"""
val cfg = """{"schema":"iglu:com.snowplowanalytics.snowplow/recoveries/jsonschema/4-0-0","data":{"iglu:com.snowplowanalytics.snowplow.badrows/schema_violations/jsonschema/2-0-0":[{"name":"passthrough","conditions":[],"steps":[{"op":"Replace","path":"$.raw.parameters.cx.data[2].data","match":"\"agent\"","value":"\"agents\""}]}]}}"""

val badrow = """{"schema":"iglu:com.snowplowanalytics.snowplow.badrows/schema_violations/jsonschema/2-0-0","data":{"processor":{"artifact":"stream-enrich","version":"1.3.2"},"failure":{"timestamp":"2021-03-16T11:41:03.021Z","messages":[{"schemaKey":"iglu:au.com.realestate/customer/jsonschema/2-0-1","error":{"error":"ValidationError","dataReports":[{"message":"$.agent: is not defined in the schema and the schema does not allow additional properties","path":"$","keyword":"additionalProperties","targets":["agent"]}]}}]},"payload":{"enriched":{"app_id":"rea-default","platform":"web","etl_tstamp":"2021-03-16 11:41:02.998","collector_tstamp":"2021-03-16 11:41:02.301","dvce_created_tstamp":"2021-02-01 23:22:29.898","event":"unstruct","event_id":"a05697dd-89dc-4d4d-a631-74960cc20bfd","txn_id":null,"name_tracker":"rea-rta-prod","v_tracker":"js-2.17.0","v_collector":"ssc-1.0.1-kinesis","v_etl":"stream-enrich-1.3.2-common-1.3.2","user_id":null,"user_ipaddress":"192.168.0.1","user_fingerprint":"2165863192","domain_userid":"d42ea50f-96cb-4c5d-9bcb-ef85c04213969","domain_sessionidx":5,"network_userid":"a83356bd-a84b-4d60-a273-1f496cc916c2","geo_country":null,"geo_region":null,"geo_city":null,"geo_zipcode":null,"geo_latitude":null,"geo_longitude":null,"geo_region_name":null,"ip_isp":null,"ip_organization":null,"ip_domain":null,"ip_netspeed":null,"page_url":"https://www.realcommercial.com.au/for-sale/qld/industrial-warehouse/?activeSort=date-desc","page_title":"3","page_referrer":"https://www.realcommercial.com.au/for-sale/qld/industrial-warehouse/?activeSort=date-desc","page_urlscheme":null,"page_urlhost":null,"page_urlport":null,"page_urlpath":null,"page_urlquery":null,"page_urlfragment":null,"refr_urlscheme":null,"refr_urlhost":null,"refr_urlport":null,"refr_urlpath":null,"refr_urlquery":null,"refr_urlfragment":null,"refr_medium":null,"refr_source":null,"refr_term":null,"mkt_medium":null,"mkt_source":null,"mkt_term":null,"mkt_content":null,"mkt_campaign":null,"contexts":"{\"schema\":\"iglu:com.snowplowanalytics.snowplow/contexts/jsonschema/1-0-0\",\"data\":[{\"schema\":\"iglu:au.com.realestate/page/jsonschema/2-0-0\",\"data\":{\"page_name\":\"rea:cxss:resi_enquiries\",\"page_type\":\"resi_enquiries\",\"site\":\"rea\",\"site_section\":\"cxss\",\"site_sub_section\":\"rea:cxss\",\"language\":\"english\",\"platform\":\"web\",\"responsive_layout\":\"L\",\"rendered_on\":\"browser\"}},{\"schema\":\"iglu:au.com.realestate/user/jsonschema/2-0-2\",\"data\":{\"user_login_status\":\"logged_in\",\"email_verified\":true,\"locke_id\":\"4e5bb289-d597-4201-b9bb-752deb2a45dd\",\"reauid\":\"05f3ce173d780000116e4c5fa50200009ff70500\"}},{\"schema\":\"iglu:au.com.realestate/customer/jsonschema/2-0-1\",\"data\":{\"customer_type\":[\"residential:sales\",\"rentAgent\"],\"about_me\":[{\"type_of_work\":[]}],\"total_claimed_profiles\":0,\"agent\":[{\"agency_id\":\"BWXGOX\",\"agent_profile_id\":\"1BDF564F\",\"permission\":[\"basic\",\"rent_application_management\"]}]}}]}","se_category":null,"se_action":null,"se_label":null,"se_property":null,"se_value":null,"unstruct_event":"{\"schema\":\"iglu:com.snowplowanalytics.snowplow/unstruct_event/jsonschema/1-0-0\",\"data\":{\"schema\":\"iglu:au.com.realestate/nearby_property_impression/jsonschema/1-0-0\",\"data\":{\"event_name\":\"nearby_property_impression\",\"index\":13,\"listings\":[{\"listing_id\":\"503499350\"},{\"listing_id\":\"502824770\"},{\"listing_id\":\"503587246\"}]}}}","tr_orderid":null,"tr_affiliation":null,"tr_total":null,"tr_tax":null,"tr_shipping":null,"tr_city":null,"tr_state":null,"tr_country":null,"ti_orderid":null,"ti_sku":null,"ti_name":null,"ti_category":null,"ti_price":null,"ti_quantity":null,"pp_xoffset_min":null,"pp_xoffset_max":null,"pp_yoffset_min":null,"pp_yoffset_max":null,"useragent":"curl/7.64.1","br_name":null,"br_family":null,"br_version":null,"br_type":null,"br_renderengine":null,"br_lang":"en-GB","br_features_pdf":1,"br_features_flash":1,"br_features_java":0,"br_features_director":0,"br_features_quicktime":0,"br_features_realplayer":0,"br_features_windowsmedia":0,"br_features_gears":0,"br_features_silverlight":0,"br_cookies":1,"br_colordepth":"24","br_viewwidth":687,"br_viewheight":700,"os_name":null,"os_family":null,"os_manufacturer":null,"os_timezone":"Australia/Brisbane","dvce_type":null,"dvce_ismobile":null,"dvce_screenwidth":1440,"dvce_screenheight":900,"doc_charset":"UTF-8","doc_width":687,"doc_height":15389,"tr_currency":null,"tr_total_base":null,"tr_tax_base":null,"tr_shipping_base":null,"ti_currency":null,"ti_price_base":null,"base_currency":null,"geo_timezone":null,"mkt_clickid":null,"mkt_network":null,"etl_tags":null,"dvce_sent_tstamp":"2021-02-01 23:22:29.901","refr_domain_userid":null,"refr_dvce_tstamp":null,"derived_contexts":null,"domain_sessionid":"ed74143c-0aa1-4d9d-b9ee-dbac180c16a7","derived_tstamp":null,"event_vendor":null,"event_name":null,"event_format":null,"event_version":null,"event_fingerprint":null,"true_tstamp":null},"raw":{"vendor":"com.snowplowanalytics.snowplow","version":"tp1","parameters":[{"name":"e","value":"ue"},{"name":"f_qt","value":"0"},{"name":"duid","value":"d42ea50f-96cb-4c5d-9bcb-ef85c04213969"},{"name":"vid","value":"5"},{"name":"f_ag","value":"0"},{"name":"maxFloorArea","value":"5000"},{"name":"minFloorArea","value":"2000"},{"name":"eid","value":"a05697dd-89dc-4d4d-a631-74960cc20bfd"},{"name":"url","value":"https://www.realcommercial.com.au/for-sale/qld/industrial-warehouse/?activeSort=date-desc"},{"name":"refr","value":"https://www.realcommercial.com.au/for-sale/qld/industrial-warehouse/?activeSort=date-desc"},{"name":"aid","value":"rea-default"},{"name":"cx","value":"eyJzY2hlbWEiOiJpZ2x1OmNvbS5zbm93cGxvd2FuYWx5dGljcy5zbm93cGxvdy9jb250ZXh0cy9qc29uc2NoZW1hLzEtMC0wIiwiZGF0YSI6W3sic2NoZW1hIjoiaWdsdTphdS5jb20ucmVhbGVzdGF0ZS9wYWdlL2pzb25zY2hlbWEvMi0wLTAiLCJkYXRhIjp7InBhZ2VfbmFtZSI6InJlYTpjeHNzOnJlc2lfZW5xdWlyaWVzIiwicGFnZV90eXBlIjoicmVzaV9lbnF1aXJpZXMiLCJzaXRlIjoicmVhIiwic2l0ZV9zZWN0aW9uIjoiY3hzcyIsInNpdGVfc3ViX3NlY3Rpb24iOiJyZWE6Y3hzcyIsImxhbmd1YWdlIjoiZW5nbGlzaCIsInBsYXRmb3JtIjoid2ViIiwicmVzcG9uc2l2ZV9sYXlvdXQiOiJMIiwicmVuZGVyZWRfb24iOiJicm93c2VyIn19LHsic2NoZW1hIjoiaWdsdTphdS5jb20ucmVhbGVzdGF0ZS91c2VyL2pzb25zY2hlbWEvMi0wLTIiLCJkYXRhIjp7InVzZXJfbG9naW5fc3RhdHVzIjoibG9nZ2VkX2luIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImxvY2tlX2lkIjoiNGU1YmIyODktZDU5Ny00MjAxLWI5YmItNzUyZGViMmE0NWRkIiwicmVhdWlkIjoiMDVmM2NlMTczZDc4MDAwMDExNmU0YzVmYTUwMjAwMDA5ZmY3MDUwMCJ9fSx7InNjaGVtYSI6ImlnbHU6YXUuY29tLnJlYWxlc3RhdGUvY3VzdG9tZXIvanNvbnNjaGVtYS8yLTAtMSIsImRhdGEiOnsiY3VzdG9tZXJfdHlwZSI6WyJyZXNpZGVudGlhbDpzYWxlcyIsInJlbnRBZ2VudCJdLCJhYm91dF9tZSI6W3sidHlwZV9vZl93b3JrIjpbXX1dLCJ0b3RhbF9jbGFpbWVkX3Byb2ZpbGVzIjowLCJhZ2VudCI6W3siYWdlbmN5X2lkIjoiQldYR09YIiwiYWdlbnRfcHJvZmlsZV9pZCI6IjFCREY1NjRGIiwicGVybWlzc2lvbiI6WyJiYXNpYyIsInJlbnRfYXBwbGljYXRpb25fbWFuYWdlbWVudCJdfV19fV19"},{"name":"f_dir","value":"0"},{"name":"tna","value":"rea-rta-prod"},{"name":"cs","value":"UTF-8"},{"name":"cd","value":"24"},{"name":"page","value":"3"},{"name":"stm","value":"1612221749901"},{"name":"tz","value":"Australia/Brisbane"},{"name":"f_pdf","value":"1"},{"name":"f_java","value":"0"},{"name":"tv","value":"js-2.17.0"},{"name":"vp","value":"687x700"},{"name":"ds","value":"687x15389"},{"name":"f_realp","value":"0"},{"name":"fp","value":"2165863192"},{"name":"res","value":"1440x900"},{"name":"f_fla","value":"1"},{"name":"cookie","value":"1"},{"name":"p","value":"web"},{"name":"dtm","value":"1612221749898"},{"name":"f_gears","value":"0"},{"name":"lang","value":"en-GB"},{"name":"includePropertiesWithin","value":"includesurrounding"},{"name":"ue_px","value":"eyJzY2hlbWEiOiJpZ2x1OmNvbS5zbm93cGxvd2FuYWx5dGljcy5zbm93cGxvdy91bnN0cnVjdF9ldmVudC9qc29uc2NoZW1hLzEtMC0wIiwiZGF0YSI6eyJzY2hlbWEiOiJpZ2x1OmF1LmNvbS5yZWFsZXN0YXRlL25lYXJieV9wcm9wZXJ0eV9pbXByZXNzaW9uL2pzb25zY2hlbWEvMS0wLTAiLCJkYXRhIjp7ImV2ZW50X25hbWUiOiJuZWFyYnlfcHJvcGVydHlfaW1wcmVzc2lvbiIsImluZGV4IjoxMywibGlzdGluZ3MiOlt7Imxpc3RpbmdfaWQiOiI1MDM0OTkzNTAifSx7Imxpc3RpbmdfaWQiOiI1MDI4MjQ3NzAifSx7Imxpc3RpbmdfaWQiOiI1MDM1ODcyNDYifV19fX0"},{"name":"sid","value":"ed74143c-0aa1-4d9d-b9ee-dbac180c16a7"},{"name":"f_wma","value":"0"}],"contentType":null,"loaderName":"ssc-1.0.1-kinesis","encoding":"UTF-8","hostname":"localhost","timestamp":"2021-03-16T11:41:02.301Z","ipAddress":"192.168.0.1","useragent":"curl/7.64.1","refererUri":null,"headers":["Timeout-Access: <function1>","Host: localhost:5000","User-Agent: curl/7.64.1","Accept: */*"],"userId":"a83356bd-a84b-4d60-a273-1f496cc916c2"}}}}"""

configs.validate(cfg)

jobs.test(cfg, badrow)
jobs.testMany(cfg, List(badrow))
